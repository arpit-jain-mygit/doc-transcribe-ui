<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Doc Transcribe</title>

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }

    button {
      margin-right: 8px;
    }

    progress {
      width: 320px;
      height: 18px;
    }

    a {
      display: inline-block;
      margin-top: 12px;
    }
  </style>
</head>

<body>

  <div id="g_id_onload" data-client_id="320763587900-18ptqosdb8b5esc8845oc82ul4qf8m9k.apps.googleusercontent.com"
    data-callback="onGoogleSignIn">
  </div>
  <div class="g_id_signin"></div>

  <button onclick="logout()">Logout</button>

  <h3>Doc Transcribe</h3>

  <input type="file" id="file" />
  <button onclick="upload('OCR')">OCR</button>
  <button onclick="upload('TRANSCRIPTION')">Transcribe</button>

  <hr>

  <div id="statusBox" style="display:none;">
    <p><b>Status:</b> <span id="status"></span></p>
    <p><b>Stage:</b> <span id="stage"></span></p>
    <progress id="progress" value="0" max="100"></progress>
  </div>

  <div id="downloadBox" style="display:none;">
    <a id="downloadLink" download>â¬‡ Download Result</a>
  </div>

  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script>
    const API = "https://doc-transcribe-api.onrender.com";
    let ID_TOKEN = null;
    let JOB_ID = null;
    let POLLER = null;

    function onGoogleSignIn(resp) {
      ID_TOKEN = resp.credential;
      alert("Signed in");
    }
    window.onGoogleSignIn = onGoogleSignIn;

    function logout() {
      ID_TOKEN = null;
      google.accounts.id.disableAutoSelect();
      alert("Logged out");
    }

    async function upload(type) {
      if (!ID_TOKEN) return alert("Sign in first");

      const file = document.getElementById("file").files[0];
      if (!file) return alert("Select a file");

      const fd = new FormData();
      fd.append("file", file);
      fd.append("type", type);

      const res = await fetch(`${API}/upload`, {
        method: "POST",
        headers: { "Authorization": "Bearer " + ID_TOKEN },
        body: fd
      });

      const data = await res.json();
      JOB_ID = data.job_id;

      document.getElementById("statusBox").style.display = "block";
      document.getElementById("downloadBox").style.display = "none";

      pollStatus();
      POLLER = setInterval(pollStatus, 4000);
    }

    async function pollStatus() {
      const res = await fetch(`${API}/status/${JOB_ID}`, {
        headers: { "Authorization": "Bearer " + ID_TOKEN }
      });
      if (res.status === 401 || res.status === 403) {
        clearInterval(POLLER);
        alert("Session expired. Please sign in again.");
        logout();
        return;
      }
      const s = await res.json();

      status.innerText = s.status;
      stage.innerText = s.stage || "";
      progress.value = Number(s.progress || 0);

      if (s.output_path) {
        downloadLink.href = s.output_path;
        downloadLink.download = "transcript.txt";
        downloadBox.style.display = "block";
        clearInterval(POLLER);
      }
    }
  </script>

</body>

</html>