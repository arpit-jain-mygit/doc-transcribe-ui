<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Doc Transcribe</title>

  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { margin-right: 8px; }
    progress { width: 320px; height: 18px; }
    a { display: inline-block; margin-top: 6px; }
    .job { border-bottom: 1px solid #ddd; padding: 8px 0; }
  </style>
</head>

<body>

<div id="g_id_onload"
  data-client_id="320763587900-18ptqosdb8b5esc8845oc82ul4qf8m9k.apps.googleusercontent.com"
  data-callback="onGoogleSignIn"></div>

<div class="g_id_signin"></div>

<button onclick="logout()">Logout</button>

<h3>Doc Transcribe</h3>

<input type="file" id="file" />
<button onclick="upload('OCR')">OCR</button>
<button onclick="upload('TRANSCRIPTION')">Transcribe</button>

<hr>

<div id="statusBox" style="display:none;">
  <p><b>Status:</b> <span id="status"></span></p>
  <p><b>Stage:</b> <span id="stage"></span></p>
  <progress id="progress" value="0" max="100"></progress>
</div>

<div id="downloadBox" style="display:none;">
  <a id="downloadLink" download>â¬‡ Download Result</a>
</div>

<hr>
<h3>My Jobs</h3>
<button onclick="loadJobs()">ðŸ”„ Refresh</button>
<div id="jobs"></div>

<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
const API = "https://doc-transcribe-api.onrender.com";
let ID_TOKEN = null;
let JOB_ID = null;
let POLLER = null;

function onGoogleSignIn(resp) {
  ID_TOKEN = resp.credential;
  loadJobs();
}
window.onGoogleSignIn = onGoogleSignIn;

function logout() {
  ID_TOKEN = null;
  google.accounts.id.disableAutoSelect();
  alert("Logged out");
}

async function upload(type) {
  if (!ID_TOKEN) return alert("Sign in first");
  const file = document.getElementById("file").files[0];
  if (!file) return alert("Select file");

  const fd = new FormData();
  fd.append("file", file);
  fd.append("type", type);

  const res = await fetch(`${API}/upload`, {
    method: "POST",
    headers: { Authorization: "Bearer " + ID_TOKEN },
    body: fd
  });

  const data = await res.json();
  JOB_ID = data.job_id;

  document.getElementById("statusBox").style.display = "block";
  pollStatus();
  POLLER = setInterval(pollStatus, 4000);
}

async function pollStatus() {
  const res = await fetch(`${API}/status/${JOB_ID}`, {
    headers: { Authorization: "Bearer " + ID_TOKEN }
  });
  const s = await res.json();

  status.innerText = s.status;
  stage.innerText = s.stage || "";
  progress.value = Number(s.progress || 0);

  if (s.output_path) {
    downloadLink.href = s.output_path;
    downloadLink.download = "transcript.txt";
    downloadBox.style.display = "block";
    clearInterval(POLLER);
    loadJobs();
  }
}

async function loadJobs() {
  if (!ID_TOKEN) return;

  const res = await fetch(`${API}/jobs`, {
    headers: { Authorization: "Bearer " + ID_TOKEN }
  });

  const jobs = await res.json();
  const box = document.getElementById("jobs");
  box.innerHTML = "";

  jobs.forEach(j => {
    const div = document.createElement("div");
    div.className = "job";
    div.innerHTML = `
      <div><b>${j.job_type}</b> â€” ${j.status}</div>
      <div>${j.updated_at || ""}</div>
      ${j.output_path ? `<a href="${j.output_path}" download>â¬‡ Download</a>` : ""}
    `;
    box.appendChild(div);
  });
}
</script>

</body>
</html>
