<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Doc Transcribe</title>

  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { margin-right: 8px; }
    progress { width: 320px; height: 18px; }
    a { display: inline-block; margin-top: 12px; }
  </style>
</head>

<body>

<h3>Doc Transcribe</h3>

<input type="file" id="file" />
<button onclick="upload('OCR')">OCR</button>
<button onclick="upload('TRANSCRIPTION')">Transcribe</button>

<hr>

<div id="statusBox" style="display:none;">
  <p><b>Status:</b> <span id="status"></span></p>
  <p><b>Stage:</b> <span id="stage"></span></p>
  <progress id="progress" value="0" max="100"></progress>
</div>

<div id="downloadBox" style="display:none;">
  <button id="downloadBtn" style="display:none" onclick="downloadResult()">
  â¬‡ Download Result
</button>

</div>

<script>
const API = "https://doc-transcribe-api.onrender.com";
let JOB_ID = null;
let POLLER = null;
let FINAL_URL = null;

async function upload(type) {
  const file = document.getElementById("file").files[0];
  if (!file) return alert("Select a file");

  const fd = new FormData();
  fd.append("file", file);
  fd.append("type", type);

  const res = await fetch(`${API}/upload`, {
    method: "POST",
    body: fd,
  });

  if (!res.ok) {
    alert(await res.text());
    return;
  }

  const data = await res.json();
  JOB_ID = data.job_id;

  document.getElementById("statusBox").style.display = "block";
  document.getElementById("downloadBox").style.display = "none";

  pollStatus();
  POLLER = setInterval(pollStatus, 4000);
}

async function pollStatus() {
  const res = await fetch(`${API}/status/${JOB_ID}`);
  if (!res.ok) return;

  const s = await res.json();

  document.getElementById("status").innerText = s.status || "";
  document.getElementById("stage").innerText = s.stage || "";
  document.getElementById("progress").value = Number(s.progress || 0);

  if (s.output_path) {
    document.getElementById("downloadLink").href = s.output_path;
    document.getElementById("downloadBox").style.display = "block";
    clearInterval(POLLER);
  }

  if (s.status === "FAILED") {
    clearInterval(POLLER);
    alert("Job failed");
  }
}

async function downloadResult() {
  if (!FINAL_URL) return alert("No file yet");

  const res = await fetch(FINAL_URL);
  const blob = await res.blob();

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "transcript.txt"; // force save
  document.body.appendChild(a);
  a.click();

  URL.revokeObjectURL(a.href);
  a.remove();
}
</script>

</body>
</html>
