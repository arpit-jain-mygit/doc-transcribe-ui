<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Doc Transcribe</title>

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    button {
      margin-right: 8px;
    }
    progress {
      width: 320px;
      height: 18px;
    }
    a {
      display: inline-block;
      margin-top: 12px;
    }
  </style>
</head>

<body>

  <!-- GOOGLE SIGN-IN -->
  <div
    id="g_id_onload"
    data-client_id="320763587900-18ptqosdb8b5esc8845oc82ul4qf8m9k.apps.googleusercontent.com"
    data-callback="onGoogleSignIn">
  </div>

  <div class="g_id_signin" data-theme="outline" data-size="large"></div>

  <button onclick="logout()">Logout</button>

  <h3>Doc Transcribe</h3>

  <input type="file" id="file" />
  <button onclick="upload('OCR')">OCR</button>
  <button onclick="upload('TRANSCRIPTION')">Transcribe</button>

  <hr>

  <div id="statusBox" style="display:none;">
    <p><b>Status:</b> <span id="status"></span></p>
    <p><b>Stage:</b> <span id="stage"></span></p>
    <progress id="progress" value="0" max="100"></progress>
  </div>

  <!-- APPROVAL -->
  <div id="approvalBox" style="display:none; margin-top:10px;">
    <button onclick="approve()">✅ Approve Result</button>
  </div>

  <!-- DOWNLOAD -->
  <div id="downloadBox" style="display:none; margin-top:10px;">
    <a id="downloadLink" download>⬇ Download Result</a>
  </div>

  <!-- GOOGLE SDK -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- APP CODE -->
  <script>
    const API = "https://doc-transcribe-api.onrender.com";

    let ID_TOKEN = null;
    let JOB_ID = null;
    let POLLER = null;

    // --------------------------------------------------
    // GOOGLE SIGN-IN
    // --------------------------------------------------
    function onGoogleSignIn(resp) {
      ID_TOKEN = resp.credential;
      console.log("Google ID token received");
      alert("Signed in");
    }
    window.onGoogleSignIn = onGoogleSignIn;

    function logout() {
      ID_TOKEN = null;
      google.accounts.id.disableAutoSelect();
      alert("Logged out");
    }

    // --------------------------------------------------
    // UPLOAD
    // --------------------------------------------------
    async function upload(type) {
      if (!ID_TOKEN) {
        alert("Please sign in with Google first");
        return;
      }

      const file = document.getElementById("file").files[0];
      if (!file) {
        alert("Select a file");
        return;
      }

      const fd = new FormData();
      fd.append("file", file);
      fd.append("type", type);

      const res = await fetch(`${API}/upload`, {
        method: "POST",
        body: fd,
        headers: {
          "Authorization": "Bearer " + ID_TOKEN
        }
      });

      if (!res.ok) {
        alert(await res.text());
        return;
      }

      const data = await res.json();
      JOB_ID = data.job_id;

      document.getElementById("statusBox").style.display = "block";
      document.getElementById("downloadBox").style.display = "none";
      document.getElementById("approvalBox").style.display = "none";

      pollStatus();
      POLLER = setInterval(pollStatus, 4000);
    }

    // --------------------------------------------------
    // STATUS POLLING
    // --------------------------------------------------
    async function pollStatus() {
      const res = await fetch(`${API}/status/${JOB_ID}`, {
        headers: {
          "Authorization": "Bearer " + ID_TOKEN
        }
      });

      if (!res.ok) return;

      const s = await res.json();

      document.getElementById("status").innerText = s.status || "";
      document.getElementById("stage").innerText = s.stage || "";
      document.getElementById("progress").value = Number(s.progress || 0);

      // --------------------------------------------------
      // APPROVAL LOGIC
      // --------------------------------------------------
      if (s.status === "COMPLETED" && s.approved === "false") {
        document.getElementById("approvalBox").style.display = "block";
        document.getElementById("downloadBox").style.display = "none";
      }

      // --------------------------------------------------
      // DOWNLOAD LOGIC
      // --------------------------------------------------
      if (s.output_path) {
        const link = document.getElementById("downloadLink");
        const box = document.getElementById("downloadBox");

        link.href = s.output_path;
        link.download = "transcript.txt";
        box.style.display = "block";

        document.getElementById("approvalBox").style.display = "none";
        clearInterval(POLLER);
      }

      if (s.status === "FAILED") {
        clearInterval(POLLER);
        alert("Job failed");
      }
    }

    // --------------------------------------------------
    // APPROVE
    // --------------------------------------------------
    async function approve() {
      const res = await fetch(`${API}/approve/${JOB_ID}`, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + ID_TOKEN
        }
      });

      if (!res.ok) {
        alert("Approval failed");
        return;
      }

      alert("Approved");
      pollStatus();
    }
  </script>

</body>
</html>
